#+TITLE: Creando historias
#+DESCRIPTION: Serie que recopila los beneficios de usar Storybook
#+AUTHOR: Sergio Ben칤tez
#+DATE:<2021-01-14 Thu> 
#+STARTUP: fold
#+HUGO_BASE_DIR: ~/Development/suabochica-blog/
#+HUGO_SECTION: /post
#+HUGO_WEIGHT: auto
#+HUGO_AUTO_SET_LASTMOD: t

Los secciones abordadas en este art칤culo, toman como referencia el proyecto
alojado en el siguiente repositorio de github:

- https://github.com/taylonr/storybook-getting-started

* Creando historias
Una historia captura el estado renderizado de un componente de la interfaz de
usuario. Los desarrolladores escriben varias historias por componente que
describen todos los estados "interesantes" que un componente puede soportar.

En el proyecto que se comparti칩 al inicio de esta publicaci칩n, en la rama
~m3-installing-storybook~, se tiene el siguiente estado: Dos historias est치n ya
definidas, Welcome y Button, y dentro de la historia Button se encuentran dos
items, ~with text~ y ~with some emoji~. Estos dos items son ejemplos de
historias. Al revisar los contenido de cada uno, se obtiene que la etiqueta del
bot칩n es diferente, demostrando as칤 dos posibles usos para el componente Button.

Cada componente de ejemplo tiene un conjunto de historias que muestran los
estados que soporta. Puede explorar las historias en la interfaz de usuario y
ver el c칩digo detr치s de ellas en archivos que terminan en ~.stories.js~ o
~.stories.ts~. Las historias est치n escritas en Component Story Format (CSF), un
est치ndar basado en m칩dulos de ES6, para escribir ejemplos de componentes.

Si se revisa el proyecto a nivel del editor de texto, se tiene el siguiente
contenido dentro de archivo ~stories/index.stories.js~:

#+begin_src js
// stories/index.stories.js
  
import React from 'react';

import { storiesOf } from '@storybook/react';
import { action } from '@storybook/addon-actions';
import { linkTo } from '@storybook/addon-links';

import { Button, Welcome } from '@storybook/react/demo';

storiesOf('Welcome', module).add('to Storybook', () => <Welcome showApp={linkTo('Button')} />);

storiesOf('Button', module)
  .add('with text', () => (
    <Button onClick={action('clicked')}>Hello Button</Button>
  ))
  .add('with some emoji', () => (
    <Button onClick={action('clicked')}>
      <span role="img" aria-label="so cool">
        游 游땙 游녨 游눮
      </span>
    </Button>
  ));

#+end_src

Es evidente que en este archivo se est치n enlistando cada una de las historias
que se describieron anteriormente. Cada grupo de historias se empieza con la
funci칩n ~storiesOf~. Debajo de la funci칩n ~storiesOf~ correspondiente al Button
se tienen dos instancias de la funci칩n ~add~, y es as칤 como se definen las
historias individuales en grupos de historias m치s grandes. Como se puede dar
cuenta, dentro de la funci칩n ~add~ se retornan componentes React. En resumen,
aqu칤 est치n las partes de una historia.

   1. El t칤tulo del grupo: Generalmente suele ser el nombre del componente (e.g. Button).
   2. El titulo de la historia: A menudo suele describir los estados de la historia (e.g. with text).
   3. El cuerpo de la historia: Son los componentes a renderizar junto con sus respectivas propiedades.

#+begin_notes
Nota: Cabe resaltar que la configuraci칩n de Storybook ha ido actualizandose con
el lanzamiento de las 칰ltimas versiones. El art칤culo [[https://medium.com/storybookjs/declarative-storybook-configuration-49912f77b78][Declarative Storybook configuration]]
aborda de manera clara la transici칩n a los nuevos est치ndares de configuraci칩n.
#+end_notes

* Escribiendo su primera historia

La primera historia que se va a escribir es otro uso de Button. Un caso
paritcular de un bot칩n es el /call to action/ para incentivar una acci칩n en el
usuario, como por ejemplo agregar un producto a un carro de compras. A
continuaci칩n se muestra el c칩dido de este elemento:

#+begin_src javascript
// components/form/cta-button.js
import React from 'react';
import Button from './button';

const CallToAction = props => (
  <Button className="crf-button crf-button--call-to-action" {...props} />
);

export default CallToAction;
#+end_src

Para empezar, este componente importa el gen칠rico Button. Luego especif칤ca
algunos nombres de clases para estilos a trav칠s del atributo ~className~, ya que
칠s la palabra reservada en react para agregar selectores CSS en nuestro
componente. Por 칰ltimo se usa el spread operator sobre los props
(i. e. ~{...props}~) para pasar todos los atributos que precisa el componente.
Con esta sintaxis se esta diciendo que todos los atributos configurados en el
CTA se van a aplicar sobre el bot칩n base.

Ahora es tiempo de visualizar el componente en Storybook. Para ello, se va a
crear el siguiente archivo dentro de la carpeta ~/stories~:

#+begin_src javascript
// stories/button.stories.js
import React from 'react';
import { storiesOf } from '@storybook/react';
import CallToAction from '../components/cta-button';

storiesOf('Button', module)
  .add('Call to Action', () => (
    <CallToAction label="Submit" />
));
#+end_src

Con este cambio, al abrir nuevamente Storybook en el navegador se puede ver que
la historia CallToAction fue agregada al grupo Button, as칤 este en un archivo
diferente. Por ahora, este b칩ton no tienen ningun estilo en particular y es
momento de personalizarlos, habilitando los selectores CSS definidos para el
componente. Para lograr este objetivo se debe actualizar el archivo ~config.js~.

#+begin_src javascript
// .storybook/config.js
import { configure } from '@storybook/react';

import "../bootstrap-reboot.min.css"
import "../bootstrap.css"
import "../bootstrap-grid.css"
import '../main.css';

// automatically import all files ending in *.stories.js
const req = require.context('../stories', true, /\.stories\.js$/);
function loadStories() {
  req.keys().forEach(filename => req(filename));
}

configure(loadStories, module);
#+end_src

Se puede notar que lo que se agreg칩 en este c칩digo fueron las importaciones de
los estilos definidos por Bootstrap en sus respectivos archivos. Al salvar estos
cambios, el servidor de Storybook va a reconstruir los archvios y si se revisa
nuevamente el navegador, el bot칩n del CallToAction ahora tiene un fondo naranja
y un texto blanco, evidenciando que los selectores definidos en el componente
est치n consumiendo los estilos establecidos por Bootstrap.

Ahora bien, regresando al estado actual del CallToAction, el bot칩n solo est치
recibiendo una etiqueta y no se esta suministrando una v칤a para atender el
evento del clic. Afortunadamente, Storybook cuenta con un complemento que viene
por defecto en su istalaci칩n llamado _actions_. Para usarlo, se deben realizar
los siguientes cambios en el archivo ~stories/button.stories.js~:

#+begin_src javascript
// stories/button.stories.js
import React from 'react';
import { storiesOf } from '@storybook/react';
import { action } from '@storybook/addon-actions';
import CallToAction from '../components/cta-button';

storiesOf('Button', module)
  .add('Call to Action', () => (
    <CallToAction
      label="Submit"
      onClick={action("button-click")}
    />
));
#+end_src

Primero, se importo el complemento directamente desde Storybook, y luego se
agreg칩 una nueva propiedad llamada ~onClick~ en la definici칩n del componente
CallToAction. Si se revisa el navegador, se pueda dar cuenta que no hay ning칰n
cambio visual sobre el componente, pero ahora, si se da clic sobre el bot칩n, en
el panel de herramienta se vera un registro del evento ejecuto sobre el bot칩n.
Para ete caso, bajo la pesta침a Actions se va imprimir el mensaje "button-click".

Esto es un pasabocas de los alcances de los complementos de Storybook. Este
tema sera desarrollado m치s adelante.

* Usando assets en la historia

Hay casos en donde los componentes requieren de assets para poder implementarse.
Un ejemplo explicito es un banner. Bajo el contexto del e-commerce se requieren
dos tipos de banner: Major y Minor. Los siguientes snippets corresponden a las
implementaciones de estos componente en React:

#+begin_src javascript
// components/major.banner.js
import React from 'react';
import PropTypes from 'prop-types';

const MajorBanner = ({
  title, subtitle, body, photo,
}) => (
  <div className="jumbotron jumbotron-fluid crf-hero d-flex" style={{ backgroundImage: `url("./${photo}")` }}>
    <div className="container d-flex flex-column justify-content-center align-items-sm-stretch align-items-md-center">
      <h1 className="col-sm-12">{title}</h1>
      <h2>{subtitle}</h2>
      <p className="lead">{body}</p>
    </div>
  </div>
);

MajorBanner.propTypes = {
  /** The last line of the text */
  body: PropTypes.string,
  /** The URL to the background image */
  photo: PropTypes.string,
  /** The middle line of text. Stands out due to color */
  subtitle: PropTypes.string,
  /** The top and most prominent portion of the text */
  title: PropTypes.string,
};

MajorBanner.defaultProps = {
  body: null,
  photo: null,
  subtitle: null,
  title: null,
};

export default MajorBanner;
#+end_src
  
#+begin_src javascript
// components/minor.banner.js
import React from 'react';
import PropTypes from 'prop-types';

const MinorBanner = ({
  title, subtitle, body, leftPhoto, rightPhoto,
}) => (
  <div className="container crf-cigar-banner">
    <div className="row">
      <div className="crf-cigar-banner--container d-flex justify-content-center align-items-center">
        {
                    leftPhoto && <img alt="Brown Boots" className="order-sm-0 order-md-0" src={leftPhoto} />
                }

        <div className="crf-cigar-banner--text order-sm-2 order-md-1">
          <div className="text-light">{title}</div>
          <div className="text-secondary">{subtitle}</div>
          <div className="text-primary">{body}</div>
        </div>
        {
                    rightPhoto && <img alt="Grey Boots" className="order-sm-1 order-md-2" src={rightPhoto} />
                }
      </div>
    </div>
  </div>
);

MinorBanner.propTypes = {
  /** The last line of the text */
  body: PropTypes.string,
  /** The URL to the left image */
  leftPhoto: PropTypes.string,
  /** The URL to the right image */
  rightPhoto: PropTypes.string,
  /** The middle line of text. Stands out due to color */
  subtitle: PropTypes.string,
  /** The top and most prominent portion of the text */
  title: PropTypes.string,
};

MinorBanner.defaultProps = {
  body: null,
  leftPhoto: null,
  rightPhoto: null,
  subtitle: null,
  title: null,
};

export default MinorBanner;
#+end_src

Notes칠 que ambos componentes requiere como propiedades algunas fotograf칤as.
Ahora es tiempo de definir la historia para el banner. La historia se va a
organizar de la siguiente manera:

- Major Banner
  - With Only Tytle
  - With All Text Options
- Minor Banner
  - No Picture
  - With Pictures

En consecuencia, se va a crear un archivo ~stories/banner.stories.js~ con el
siguiente contenido:

#+begin_src javascript
// stories/banner.stories.js
import React from 'react';
import { storiesOf } from '@storybook/react';
import MajorBanner from '../components/major.banner';
import MinorBanner from '../components/minor.banner';

storiesOf('Major Banner', module)
  .add('With Only Title', () => (
    <MajorBanner title="Banner Title" photo="People Outdoors/shutterstock_116403520.jpg" />
  ))
  .add('With All Text Options', () => (
    <MajorBanner
      photo="People Outdoors/shutterstock_116403520.jpg"
      title="Banner Title"
      subtitle="Banner Subtitle"
      body="Banner Body"
    />
  ));

storiesOf('Minor Banner', module)
  .add('No Pictures', () => (
    <MinorBanner title="Banner Title" subtitle="Banner Subtitle" body="Banner Body" />
  ))
  .add('With Pictures', () => (
    <MinorBanner
      title="Banner Title"
      subtitle="Banner Subtitle"
      body="Banner Body"
      leftPhoto="Products/boots/shutterstock_66842440.jpg"
      rightPhoto="Products/boots/shutterstock_1121278055.jpg"
    />
  ));
#+end_src

Se se revisa el estado actualmente de las nuevas historias que se agregaron, se
observa que fueron incluidas dentro del panel lateral de Storybook, pero los
componentes se est치n renderizando sin las fotograf칤as. Esto se debe a que
Storybook no tiene las herramienta para encontrar las rutas especificadas en las
propiedades ~photo~ del MajorBanner y ~leftPhoto~, ~rightPhoto~ del MinorBanner.

Para solucionar este percance, se debe actualizar el script de Storybook en el
~packages.json~ indicando la carpeta en donde se van a almacenar los assets del
proyecto. Para esta caso puntual el directorio es ~/Images~ y en consecuencia el
script quedar칤a as칤:

#+begin_src json
// package.json
...
  "scripts": {
    "storybook": "start-storybook -s ./Images -p 6006",
  },
...
#+end_src

Con la opci칩n ~-s~ se especifica la ruta en donde se van a almacenar los
archivos est치ticos del proyecto. El gran beneficio de realizar esta
configuraci칩n es que ahora los componentes se est치n perfilando para consolidarse
en la applicaci칩n final

* Agrupando historias
Storybook es una herramienta utilizada para realizar prototipado r치pido y es
칰til saber rapidamente que componentes existen. Para ello, definir una
convenci칩n para organizar las historias es de gran ayuda, y Storybook ofrece
varias sint치xis para establecer la estructura del directorio de historias:

Actualmente, el navegador despliega las siguientes historias:

#+CAPTION: Current stories organization
[[../images/storybook/03-storybook-current-stories.png]]

La primera asociaci칩n a realizar es la de agrupar el Major y el Minor Banner, en
una categoria Banner. Para lograr esta jerarqu칤a se debe actualizar el t칤tulo
de las historias del banner bajo la siguiente convenci칩n:

#+begin_src javascript
// stories/banner.stories.js
import React from 'react';
import { storiesOf } from '@storybook/react';
import MajorBanner from '../components/major.banner';
import MinorBanner from '../components/minor.banner';

storiesOf('Banners/Major', module)
  .add('With Only Title', () => (...))
  .add('With All Text Options', () => (..));

storiesOf('Banners/Minor', module)
  .add('No Pictures', () => (...))
  .add('With Pictures', () => (...));
#+end_src

Con este cambio en el t칤tulo, el navegador va a organizar las historia como se
muestra en la siguiente imagen:

#+CAPTION: Organizing stories by component
[[../images/storybook/04-storybook-grouping-stories-by-component.png]]


Se puede agregar otro nivel en el 치rbol utilizando el car치cter ~/~. Por ejemplo,
si el t칤tulo de la historia se cambia por ~'Banners/Adverstiment/Major'~, se
mostrar칤an tres niveles en la estructura del 치rbol. Esta covenci칩n es
equivalente a las rutas de los archivos definidas a trav칠s de una terminal.

Adicionalmente, Storybook ofrece otra sintaxis para agrupar las historias dentro
de etiquetas, tal y como se muestra en este snippet:

#+begin_src javascript
// stories/banner.stories.js
import React from 'react';
import { storiesOf } from '@storybook/react';
import MajorBanner from '../components/major.banner';
import MinorBanner from '../components/minor.banner';

storiesOf('Component | Banners/Major', module)
  .add('With Only Title', () => (...))
  .add('With All Text Options', () => (..));

storiesOf('Component | Banners/Minor', module)
  .add('No Pictures', () => (...))
  .add('With Pictures', () => (...));
#+end_src

Ahora, el panel lateral de Storybook organizar치 las historias con el formato de
abajo:

#+CAPTION: Organizing stories by label
[[../images/storybook/05-storybook-grouping-stories-by-label.png]]

Esta ofertas en sint치xis ayudan a romper Storybook en distinciones
significativas. Algunas etiquetas comunes son 'Foundational' en donde se agrupan
cosas como la tipograf칤a y el espaciado. Otra es 'Form elements' para reunir
elementos como botones y cajas de entrada de texto. En 칰ltimas la elecci칩n
de un esquema de organizaci칩n realmente la toma el equipo de trabajo.

* Tematizando Storybook

Otro de los atractivos de Storybook es que es una herramienta personalizable.
Eso significa, que para cuestiones de marca se pueden hacer una serie de
configuraciones para evitar que Storybook se visualice como una herramienta
gen칠rica.

Siguiendo con el hilo del e-commerce, a continuaci칩n se va a crear un archivo
~.storybook/crfTheme.js~ en donde se va a configurar el tema de la marca sobre
Storybook:

#+begin_src javascript
// .storybook/crfTheme.js
import { create } from '@storybook/theming';

export default create({
    base: 'dark',
    brandTitle: 'Carved Rock Fitness',
    brandImage: 'Logos/carved-rock-logo-yellow.png',
    colorSecondary: '#faa541'
});
#+end_src

Lo mas importante en este snippet es la importaci칩n de la funci칩n ~create~, la
cual recibe como argumento un objeto con las siguientes configuraciones:

- La propiedad ~base~ indica que nuestra tema va a ser oscuro, en vez de claro.
- La propiedad ~brandTitle~ establece el t칤tulo de la marca
- La propiedad ~brandImage~ usa el logo de la marca
- La propiedad ~colorSecondary~ actualiza el color de fondo de la historia consultada

Para poder utilizar este archivo de configuraci칩n se debe acualizar el archivo
~.storybook/config.js~.

#+begin_src javascript
// .storybook/config.js
import { addParameters, configure } from '@storybook/react';
import crfTheme from './crfTheme';

...

addParameters({
  options: {
    theme: crfTheme
  }
})

configure(loadStories, module);
#+end_src

Lo relevante en este snippet en cuanto personalizaci칩n de tema es la importaci칩n
de la funci칩n ~addParameters~ y el archivo ~crfTheme~ implementado anteriormente.
La funci칩n ~addParameters~ recibe como argumento un objeto con las posibles
opciones personificables de Storybook. Para este caso puntual a la llave ~theme~
se le pasa el valor ~crfTheme~. Si se actualiza el navegador, ahora la interfaz
de Storybook ser치 como:

#+CAPTION: Theming Storybook
[[../images/storybook/06-storybook-theming.png]]

Storybook tiene muchos m치s elementos que son personalizables. Para saber m치s
sobre dichas opciones se hace la invitaci칩n a revisar la documentaci칩n oficial
de Storybook en la secci칩n [[https://storybook.js.org/docs/react/configure/theming][Theming]].

* Problemas comunes y recordatorios

A continuaci칩n se recopila una serie de problemas comunes que se presentan con
storybook:

- La historia no se muestra. Para solucionar este inconveniente, asegures칠 de
  que el nombre del archvio es correcto y coincide con la expresi칩n definida
  en el archivo de configuraci칩n. Para este caso la ruta es ~../stories~
- Los componentes no estan con los estilos esperados. Para resolver este
  problema recuerde importar los archivos CSS en el ~config.js~
- Los assets est치n perdidos. Para ajustar este contratiempo, recuerde indicar
  la ruta de los archivos 칠staticos en el script de storybook definido en el
  ~package.json~.
 

